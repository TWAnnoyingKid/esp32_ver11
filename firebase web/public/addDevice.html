<!DOCTYPE html>
<html class="head">
    <head >
        <title id="Title">addDevices</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="style.css">
        <!-- <script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="crossorigin="anonymous"></script> -->
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
        
    </head>
    <body Align="Center">
        <section class="mainlayout">
            <div class="mainheader">
                <div class="SS" onclick="location.href='mainpage.html'">
                    <div style="width:35%">
                        <img src="picture\sloth.png" width="90%" height="90%">  
                    </div>
                    <h1> sMART <br> sTUFF</h1>
                </div>
            </div>
            <div class="maincenter">
                <div class="NEWdeviceBtn">
                    <button id="search" onclick="ipSet.showModal()" style="width: 150px; height: 35px; font-size: 20px; font-weight: 700;">搜尋裝置</button></div>
                    <br>
                    <div id="deviceplace" style="overflow-y:scroll; height: 435px; width: 380px;" Align="Center"></div>
                </div>
            <div class="mainfooter">
                    <div class="goBackDevicePage">
                        <a href="devicepage.html">
                            <button type="button" id="back" class="back">回到裝置頁</button><br>
                        </a>
                    </div>
                </div>
        </section>

        <dialog id="ipSet">
            <h1>請輸入連線至的WIFI的IP位址</h1>
            <input id="ip1" maxlength="3" minlength="1" placeholder="192" style="width: 50px;" value="192"> .
            <input id="ip2" maxlength="3" minlength="1" placeholder="168" style="width: 50px;" value="168"> .
            <input id="ip3" maxlength="3" minlength="1" placeholder="xxx" style="width: 50px;" value="31"> .
            <input id="ip4" maxlength="3" minlength="1" placeholder="xxx" style="width: 50px;" value="31">   
            <p>  </p>
            <button id="ipSetconfirm" >確認</button>
            <button onclick="ipSet.close()">取消</button>
        </dialog>
        <dialog id="ipSetError">
            <h1>IP位址輸入錯誤</h1>
            <button onclick="ipSetError.close()">取消</button>
        </dialog>
        <dialog id="deviceSet">
            <h1>請輸入裝置名稱</h1>
            <p id="macinfo" style="display: none;"></p>
            <p id="eleinfo" style="display: none;"></p>
            <input type="text" id="devicename" style="width: 150px; height: 20px; font-size: 15px;">
            <button id="deviceSetconfirm" >確認</button>
            <button onclick="deviceSet.close()">取消</button>
        </dialog>
        <dialog id="UserLost">
            <h1>糟糕! 甚麼地方出錯了!<br>請再試一次!</h1>
            <button onclick="UserLost.close(); location.href='mainpage.html'">確認</button>
        </dialog>
        
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js"
            const firebaseUserConfig = {
                apiKey: "AIzaSyCF75el0I5Ni587JaOnNVOoqAzWuJG2agY",
                authDomain: "user-login-time.firebaseapp.com",
                databaseURL: "https://user-login-time-default-rtdb.firebaseio.com",
                projectId: "user-login-time",
                storageBucket: "user-login-time.appspot.com",
                messagingSenderId: "975739925033",
                appId: "1:975739925033:web:bbb3193030ed8e5425e238",
                measurementId: "G-KYLDQQK1GK"
            };
            const firebaseDeviceConfig = {
                apiKey: "AIzaSyAF4OdtYUAomk_4WnvE5MXb_nphlQ33UyA",
                authDomain: "esp8266-ai2.firebaseapp.com",
                databaseURL: "https://esp8266-ai2-default-rtdb.firebaseio.com",
                projectId: "esp8266-ai2",
                storageBucket: "esp8266-ai2.appspot.com",
                messagingSenderId: "245671703015",
                appId: "1:245671703015:web:28612316e5ec39dd6bcd42"
            };

            const userApp = initializeApp(firebaseUserConfig);
            const deviceApp = initializeApp(firebaseDeviceConfig, "secondary");
            import { getDatabase, get , ref, child, onValue, update, set } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";
            const userdb = getDatabase(userApp);
            const devicedb = getDatabase(deviceApp);
            
            var user = Cookies.get('user')
            var ipSet = document.querySelector('#ipSet')
            var ipSetconfirm = document.querySelector('#ipSetconfirm')
            var search = document.querySelector('#search')
            var deviceplace = document.getElementById('deviceplace')
            var deviceSetconfirm = document.getElementById('deviceSetconfirm')
            var macinfo = document.getElementById('macinfo')
            var eleinfo = document.getElementById('eleinfo')

            if(!Cookies.get('user')){
                UserLost.showModal()
            }
            if(Cookies.get('device')){
                Cookies.remove('device')
            }
            if(!Cookies.get('saveName')){
                var saveName = 0
            }else{
                var saveName = Cookies.get('saveName').split("裝置")[1]
            }
            

            function urlSet(){
                if(ip1.value != '' && ip2.value != '' && ip3.value != '' && ip4.value != ''){
                    var urlfront = ip1.value +'.'+ ip2.value +'.'+ ip3.value +'.'
                    ipSet.close()
                    urlFinding(urlfront)
                }else{
                    ipSetError.showModal()
                }
            }
            function urlFinding(urlfront){
                var i=1
                while(i < 254){
                    var url = 'http://' + urlfront + i + '/info'
                    axios.get(url)
                    .then(function (response) {
                        var data = response.data
                        var mac = data.split("MAC=")[1].split("</h1>")[0]
                        var ele = data.split("ELEMENT=")[1].split("</h2>")[0]
                        var name = data.split("裝置名稱 = ")[1].split("</h3>")[0]
                        const devicedbref = ref(devicedb);
                        if(data.includes("sMART sTUFF")){
                            get(child(devicedbref, mac + "/USER" + user))
                            .then((snapshot)=>{
                                if (snapshot.exists() != true) {
                                    addBTN(mac,ele,name)
                                }
                            })
                        }
                    })
                    .catch(function (error) {
                        console.log(error);
                    }) 
                    i++
                }
            } 
            function addBTN(mac,ele,name){     
                var BTNadd = document.createElement('button')
                var p = document.createElement('p')
                BTNadd.name = "NEWdevices"
                BTNadd.class = ele
                BTNadd.id = mac
                BTNadd.innerHTML = name
                p.innerHTML=" "
                p.id = mac
                BTNadd.onclick = function deviceSetup(){
                    deviceSet.showModal(mac,ele)
                    macinfo.innerHTML = mac
                    eleinfo.innerHTML = ele
                }
                deviceplace.appendChild(BTNadd);
                deviceplace.appendChild(p);
            }

            function saveDevice(){
                var saveNameTag = "裝置" + (saveName + 1)
                if(eleinfo.innerHTML == 'strip'){
                    var dset = '"' + devicename.value + ' ' + macinfo.innerHTML + ' ' + eleinfo.innerHTML + '"'
                    update(ref(userdb, user +"/裝置8"),{
                        set : dset
                    })
                    update(ref(devicedb, macinfo.innerHTML + '/USER' + user),{
                        USER: user
                    })
                    update(ref(devicedb, macinfo.innerHTML),{
                        MODE: "5"
                    })
                    var dBTN = document.getElementById(macinfo.innerHTML);
                    dBTN.remove();
                }else if(eleinfo.innerHTML == 'bme' || eleinfo.innerHTML == 'moi'){
                    var dset = '"' + devicename.value + ' ' + macinfo.innerHTML + ' ' + eleinfo.innerHTML + '"'
                    update(ref(userdb, user +"/裝置8"),{
                        set : dset
                    })
                    update(ref(devicedb, macinfo.innerHTML + '/USER' + user),{
                        USER: user
                    })
                    var dBTN = document.getElementById(macinfo.innerHTML);
                    dBTN.remove();
                }else if(eleinfo.innerHTML == '3stat'){
                    var dset = '"' + devicename.value + ' ' + macinfo.innerHTML + ' ' + eleinfo.innerHTML + " 插座1 插座2 插座3" + '"'
                    update(ref(userdb, user +"/裝置8"),{
                        set : dset
                    })
                    update(ref(devicedb, macinfo.innerHTML + '/USER' + user),{
                        USER: user
                    })
                    var dBTN = document.getElementById(macinfo.innerHTML);
                    dBTN.remove();
                }else if(eleinfo.innerHTML == 'drlk'){
                    var dset = '"' + devicename.value + ' ' + macinfo.innerHTML + ' ' + eleinfo.innerHTML + " 智慧門鎖" + '"'
                    update(ref(userdb, user +"/裝置8"),{
                        set : dset
                    })
                    update(ref(devicedb, macinfo.innerHTML + '/USER' + user),{
                        USER: user
                    })
                    var dBTN = document.getElementById(macinfo.innerHTML);
                    dBTN.remove();
                }
                deviceSet.close()
            }

            ipSetconfirm.addEventListener('click', urlSet)
            deviceSetconfirm.addEventListener('click', saveDevice)
        </script>
    </body>
</html>